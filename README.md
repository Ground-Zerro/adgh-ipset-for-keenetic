# AdGuard Home with IPSet Routing

**AdGuard Home with IPSet Routing** — это скрипт для автоматической настройки маршрутизации трафика через IPSet на маршрутизаторах с поддержкой AdGuard Home. Основная цель — перенаправление запросов определенных доменов через VPN или обход локального DNS провайдера. 

## Возможности:
- Настройка и интеграция IPSet с AdGuard Home для управления маршрутизацией.
- Создание скриптов для динамической маршрутизации и маркировки трафика.
- Поддержка IPv4 и IPv6.
- Пример базового списка доменов для перенаправления (можно легко расширять).

## Требования:
- KeenOS версия 4.х
- Развёрнутая среда [Entware](https://help.keenetic.com/hc/ru/articles/360021214160-Установка-системы-пакетов-репозитория-Entware-на-USB-накопитель).
- Рабочее VPN-соединение поверх провайдерского, по которому будет идти обращение к выбранным вами доменам.
- Для работы через ipv6 - наличие рабочего ipv6 на основном подключении и на VPN-соединении.

## Как использовать:
1. Подключиться к роутеру по SSH (к развернутому Entware)
2. Выполнить код:
	```
	curl -L -s "https://raw.githubusercontent.com/Ground-Zerro/adgh-ipset-for-keenetic/refs/heads/main/adgh-ipset.sh" > /tmp/adgh-ipset.sh && chmod +x /tmp/adgh-ipset.sh && sh /tmp/adgh-ipset.sh
	```
3. Следовать инструкциям.
4. Завершить настройку AdGuardHome перейдя по адресу: http://192.168.1.1:3000/ (где `192.168.1.1` - IP-адрес роутера).
5. Првоерить работу перейдя на [2ip.ru](https://2ip.ru/), в поле `Ваш IP адрес:` должен отображаться IP-адрес подчключения, через которое вы перенаправите трафик (VPN).

## Дополнительная информация:
**Как добавить домены в ipset**
1. Чтобы добавить домены для перенаправления, отредактируйте файл: `/opt/etc/AdGuardHome/ipset.conf`.
	```
	nano /opt/etc/AdGuardHome/ipset.conf
	```
   <details>
   <summary>Синаксис файла `ipset.conf` (нажать, чтобы прочесть подробней)</summary>
	```
	intel.com,2ip.ru/bypass,bypass6
	instagram.com,cdninstagram.com/bypass,bypass6
	openai.com,chatgpt.com/bypass,bypass6
	```
	- В левой части через запятую указаны домены, требующие обхода блокировок,
	- Справа после слэша — ipset, в который AGH складывает результаты разрешения DNS-имён.
	- Можно указать всё в одну строчку, можно разделить логически на несколько строк как в примере.
	- Домены третьего уровня и выше также включаются в обход блокировок, т.е. указание `intel.com` включает `www.intel.com`, `download.intel.com` и прочее.
	В прмиере доабвлен «сигнальный» сервис [2ip.ru](https://2ip.ru/), для првоерки работоспособности решения, показывающий IP-адрес туннеля (VPN), через которое вы перенаправите трафик.
   </details>

2. После добавления доменов необходимо перезапустить **AdGuard Home** командой:
	```
	/opt/etc/init.d/S99adguardhome restart
```
